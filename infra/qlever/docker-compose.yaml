services:
  # One-shot init container to fix permissions on the data volume
  qlever-init:
    image: busybox:latest
    container_name: qlever-init
    command: ["sh", "-c", "chown -R 65534:0 /data"]
    volumes:
      - ./qlever-data:/data
    restart: "no"

  qlever-server:
    build:
      context: .
      dockerfile: ./Dockerfile
    image: local/qlever-server:latest
    container_name: qlever-server
    user: "65534:0"          # run as 'nobody' (uid 65534), group root
    depends_on:
      - qlever-init          # make sure perms are fixed first
    env_file:
      - ./qlever.env         # QLever + indexing config (see below)
    volumes:
      - ./qlever-data:/data      # QLever index + Qleverfile live here
      - ./data/data.nt:/data/data.nt:ro  # your RDF data file
    ports:
      - "7001:7001"          # SPARQL endpoint
    stop_grace_period: 0s
    restart: unless-stopped
